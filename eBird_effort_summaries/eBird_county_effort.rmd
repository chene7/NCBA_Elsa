---
title: "eBird Sampling Effort Summaries"
author: "N.M. Tarr"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  rmdformats::downcute:
  html_document:
    df_print: paged
    code_folding: hide

---
# Purpose
This notebook summarizes eBird sampling (effort) within North Carolina for the past 20 years.  Sampling data can be downloaded from the eBird website and queried with eBird's R package named "auk".  The script named "filter_eBird_sampling.R", which is saved in the NCBA github repo, performs the filtering that supports this notebook.  

The records available from the sampling data set are for individual, unique checklists and several attributes are included for each.  This notebook summarizes the available attribute values to learn as much as possible about the modern eBird effort to date within North Carolina.  The available checklist attributes are:

* checklist_id            
* last_edited_date        
* county
* county_code
* iba_code                  
* bcr_code                
* usfws_code                
* atlas_block              
* locality                  
* locality_id              
* locality_type             
* latitude                
* longitude                 
* observation_date 

* time_observations_started 

* observer_id              
* sampling_event_identifier 

* protocol_type            
* protocol_code             
* project_code            
* duration_minutes          
* effort_distance_km      
* effort_area_ha            
* number_observers        
* all_species_reported      
* group_identifier        
* trip_comments   

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE)

library(auk)
library(tidyverse)
library(ggplot2)
theme_set(theme_bw())
library(sf)
library(RColorBrewer)
library(maps)
starttime <- Sys.time()

# Reference the filtered checklist output file
filtered_checklists <- "~/Documents/NCBA/Data/filtered_checklists.txt"

# Read in the effort data (filtered checklist table).
checklists <- read_sampling(filtered_checklists)

comma <- function(x) format(x, digits=2, big.mark=",")
```

Read in a county simple features collection
```{r counties_data}
counties <- st_as_sf(map("county", plot = FALSE, fill = TRUE)) %>%
  subset(grepl("north carolina", ID)) %>%
  mutate(county = str_to_title(str_replace(ID, "north carolina,", ""))) %>%
  select(-c(ID))
# Reproject?
```

# Checklist Count
There are currently `r comma(length(unique(checklists$checklist_id)))` checklists from North Carolina in eBird.

# Checklist Locations
```{r xy_locations}
ggplot(data=checklists) +
  geom_point(mapping=aes(y=latitude, x=longitude), color="darkgreen",
             shape=3) + 
  labs(title="EBird checklist coordinates are widely distributed within NC",
       caption="Checklists from before 2000 are not shown") +
  ylab("latitude") + 
  xlab("longitude")
```

# Checklists per County
```{r per_county_bwplot}
by_county <- checklists %>%
  group_by(county) %>%
  summarize(
    count = n(),
  ) %>%
  arrange(county) 

# We will need median # checklists for below
median.checklists <- toString(comma(summary(by_county$count)[[3]]))
ggplot(data=by_county) +
  geom_boxplot(mapping=aes(y=count, x=""), color="orange", 
               outlier.colour="darkred", show.legend=TRUE) + 
  coord_flip() + 
  labs(title="A handful of counties have many more checklists than others",
       subtitle=str_c("The median number of checklists in a county was ",
                      median.checklists),
       caption="Checklists from before 2000 are not included") +
  ylab("Checklists (n)") + 
  scale_y_continuous(n.breaks=12)
```

Between `r comma(summary(by_county$count)[[1]])` and `r comma(summary(by_county$count)[[6]])` checklists are available for counties in North Carolina, and the median number of checklists is `r comma(summary(by_county$count)[[3]])`.

```{r per_county_map}
# Join to get the checklist count
counties.checklists <- counties %>%
  left_join(by_county, by = "county")

# Pull out just the column of interest here ("count") and plot it.
county.count <- select(counties.checklists, count, geom)
# plot(county.count, main="Number of Checklists Attributed to Counties by eBird")
ggplot(data=county.count) +
  geom_sf(data=counties.checklists, aes(fill=count)) +
  labs(title="Counties with large cities are heavily sampled",
       caption="Checklists from before 2000 are not included")
```

## Top 10 Counties
```{r top_county_table}
knitr::kable(head(arrange(by_county, desc(count)), n=10), caption="Top 10 Counties")
```

```{r top_county_map}
# Add a column to record whether it's a "top" or "bottom" county as far as count goes.
tops <- counties.checklists %>% arrange(desc(count)) %>% head(n=10)
bottoms <- counties.checklists %>% arrange(count) %>% head(n=10)
counties.checklists <- counties.checklists %>%
  mutate(top10 = ifelse(count %in% tops$count, TRUE, FALSE)) %>%
  mutate(bottom10 = ifelse(count %in% bottoms$count, TRUE, FALSE)) %>%
  arrange(desc(count))

# Pull out just the column of interest here ("count") and plot it.
tops2 <- counties.checklists %>%
  select(top10, geometry)
plot(tops2, main="Top 10 Counties for Number of eBird Checklists")
```

## Bottom 10 Counties
```{r bottom_county_table}
knitr::kable(head(arrange(by_county, count), n=10), caption="Bottom 10")
```

```{r bottom_county_map}
# Pull out just the column of interest here ("count") and plot it.
bottoms2 <- counties.checklists %>%
  select(bottom10, geometry)
plot(bottoms2, main="Bottom 10 Counties for Number of eBird Checklists")
```

## Checklists per County Table
Note, the assignment of checklists to counties was performed by eBird and it is possible that errors exist due to traveling counts that cross county lines and errors in the recorded locations of checklists.
```{r per_county_all}
knitr::kable(by_county, caption="")
```

# Runtime
```{r runtime}
endtime <- Sys.time()
runtime <- endtime - starttime
```
`r format(runtime)`