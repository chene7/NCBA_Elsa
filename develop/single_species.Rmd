---
title: "Single Species Summary"
author: "N.M. Tarr"
date: "9/8/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Paths
```{r}
sp <- "Kentucky Warbler"
ebd_file <- "~/Data/ebd_US-NC_202103_202109_relJul-2021.txt"
EBD_output <- "~/Documents/NCBA/Species/testSP.txt"
```

Load packages
```{r}
library(auk)
library(dplyr)
library(mongolite)
```

# MONGO DB
```{r}
USER = "ncba_ruser"
PASS = "Ammospizacaudacuta"
#> this is a read only account
HOST = "cluster0-shard-00-00.rzpx8.mongodb.net:27017"
DB = "ebd_mgmt"
COLLECTION = "ebd"
#> other relevant collections include: blocks and ebd_taxonomy

URI = sprintf("mongodb://%s:%s@%s/%s?authSource=admin&replicaSet=atlas-3olgg1-shard-0&readPreference=primary&ssl=true",USER, PASS, HOST, DB)

#> connect to a specific collection (table)
m <- mongo(COLLECTION, url = URI)
print (m)

#> return record with the following SAMPLING_EVENT_IDENTIFIER
#> this query follows JSON based query syntax (see here for the basics: https://jeroen.github.io/mongolite/query-data.html#query-syntax)
testdata <- m$find('{"SAMPLING_EVENT_IDENTIFIER":"S79697260"}')
#> looks like it dumps it right into a dataframe? will have to work through how to get observations (sub-documents)
print(testdata)
```

# EBD
Read the EBD database
```{r}
df1 <- ebd_file %>% 
       # 1. reference file
       auk_ebd() %>% 
       # 2. define filters
       auk_species(species = sp) %>% 
       # 3. run filtering
       auk_filter(file = EBD_output) %>% 
       # 4. read text file into r data frame
       read_ebd()
```

# Data Summaries
Summarize by breeding codes
```{r}
df2 <- df1 %>%
       # Summarize by number checklists within each block
       group_by(breeding_code) %>%
       summarize(reports=n())
```